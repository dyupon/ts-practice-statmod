\section{Метод разложения STL}

Усовершенствованный classical seasonal decomposition.
Расшифровывается как "Seasonal and Trend decomposition using Loess". В \texttt{R} это функция \texttt{stats::stl}.

Рассматриваем аддитивную модель ряда:
\begin{equation*}
\mathsf{X}_{t}=\mathsf{T}_{t}+ \mathsf{C}_t + \mathsf{S}_{t}+ \mathsf{N}_{t}.
\end{equation*}

Здесь $\mathsf{C}_t$ --- циклическая компонента, ранее мы неявно включали её в периодическую.

Метод состоит из двух циклов: внешнего и внутреннего. Внешний цикл нужен для решения проблем с выбросами и пропущенными значениями, он такой же, как в LOESS. На каждой итерации внешнего цикла выполняется внутренний цикл, который и заключается в разложении ряда на тренд, сезонность и отстаток. Опишем итерацию внутреннего цикла.

На вход на $k+1$ внутренний цикл поступает ряд $\mathsf{X}_N$ длины $N$, $\mathsf{T}_N^k$ -- выделенный на предыдущем шаге тренд. Полагаем $\mathsf{T}_N^0 \equiv 0$.

\begin{enumerate}
	\item  Удаляем тренд: $\mathsf{Y}_N = \mathsf{X}_N - \mathsf{T}_N^k$;
\item Сглаживаем ряд $\mathsf{Y}_N$ с помощью $LOESS(span = n_s, d = 1)$, мы также предсказываем $n_p$ значений до начала ряда и после. В результате получаем ряд $\mathsf{C}_{N + 2n_p}^{k+1}$ -- сглаженную циклическую составляющую;
\item Применяем низкочастотный фильтр к $\mathsf{C}_{N + 2n_p}^{k+1}$: дважды скользящее среднее с окном $n_p$, и ещё раз -- с окном $3$. К полученному после усреднения ряду применяем $LOESS(span = n_l, d = 1)$. В результате получаем ряд $\mathsf{L}_N^{k+1}$ длины $N$;
\item Выделяем сезонную составляющую: $\mathsf{S}_N^{k+1} = \mathsf{C}_N^{k+1} - \mathsf{L}_N^{k+1}$. Здесь мы игнорируем первые и последние $n_p$ значений ряда $\mathsf{C}_{N+2n_p}^{k+1}$;
\item Удаляем сезонность из исходного ряда: $\mathsf{X}_N - \mathsf{S}_N^{k+1}$;
\item Сглаживаем получившийся после удаления сезонности ряд с помощью $LOESS(span = n_t, d = 1)$.
\end{enumerate}
Параметры $LOESS$ -- это значение $span$ и $d$, $span$ -- количество ближайших наблюдений, которые берутся для предсказания значения в некоторой точке $x$. На этом множестве строится полином степени $d$, который и используется для предсказания $x$. (На самом деле, наблюдениям ещё задаются веса в зависимости от расстояния от $x$. С помощью этих весов мы можем, например, уменьшить влияние выбросов).

\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{stl.png}}
	\caption{Декомпозиция ряда на аддитивные составляющие}
\end{figure}